<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TPC Internal Dashboard</title>
  <style>
    :root{
      --bg:#0b0c0f; --card:#14161c; --muted:#9aa3b2; --text:#e7eaf0;
      --accent:#10744d; --accent2:#22c55e; --danger:#ef4444; --line:#1f2330;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(11,12,15,0.98), rgba(11,12,15,0.9));
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
    }
    .title{font-size:18px; font-weight:800; display:flex; align-items:center; gap:8px;}
    .subtitle{font-size:12px; color:var(--muted); margin-top:4px;}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      background:#0f1117; border:1px solid #202432; color:var(--text);
      padding:6px 10px; border-radius:999px; font-size:12px; display:inline-flex; gap:6px; align-items:center;
    }
    .chip .dot{width:7px;height:7px;border-radius:50%;background:var(--muted);}
    .chip.ok .dot{background:var(--accent2);}
    .chip.err .dot{background:var(--danger);}

    main{padding:12px; max-width:900px; margin:0 auto;}
    .controls{
      display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap;
    }
    button, select, input{
      background:#0f1117; color:var(--text); border:1px solid #202432;
      padding:10px 12px; border-radius:12px; font-size:14px; outline:none;
    }
    #searchInput{flex:1; min-width:200px;}
    button{cursor:pointer}
    button.primary{border-color:transparent; background:var(--accent2); color:#0b0c0f; font-weight:800;}
    button.ghost{background:transparent}
    .tabs{
      display:flex; gap:8px; margin:6px 0 12px;
    }
    .tab{
      flex:1; text-align:center; padding:10px 8px; border-radius:12px;
      background:#0f1117; border:1px solid #202432; font-weight:700; font-size:14px;
    }
    .tab.active{background:#182016; border-color:#2a3b21; color:#dff7c0;}

    .list{display:grid; gap:10px;}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:12px;
    }
    .card h3{margin:0 0 4px; font-size:15px;}
    .meta{font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:10px;}
    .pill{
      font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #25304a;
      background:#0f1117; color:#cbd5e1;
    }
    .kv{margin-top:8px; display:grid; grid-template-columns:120px 1fr; gap:6px 10px; font-size:13px;}
    .kv div:nth-child(odd){color:var(--muted)}
    .empty{color:var(--muted); text-align:center; padding:30px 10px;}

    @media(min-width:700px){
      header{padding:16px 22px 12px;}
      main{padding:18px;}
      .kv{grid-template-columns:160px 1fr;}
    }
  </style>
</head>
<body>

<header>
  <div class="title">üß≠ TPC Internal Monitor</div>
  <div class="subtitle">Customers + Meeting Requests (live)</div>
  <div class="row">
    <div id="connChip" class="chip"><span class="dot"></span><span id="connText">Not connected</span></div>
    <div class="chip">Customers: <b id="customersCount">‚Äì</b></div>
    <div class="chip">Meeting requests: <b id="meetingsCount">‚Äì</b></div>
    <div class="chip">Last refresh: <span id="lastRefresh">‚Äì</span></div>
  </div>
</header>

<main>
  <div class="controls">
    <button id="refreshBtn" class="primary">Refresh now</button>
    <button id="autoBtn" class="ghost">Auto: Off</button>
    <select id="limitSelect">
      <option value="25">Last 25</option>
      <option value="50" selected>Last 50</option>
      <option value="100">Last 100</option>
      <option value="250">Last 250</option>
    </select>
    <input id="searchInput" type="search" placeholder="Search profile_name / number‚Ä¶" />
    <button id="downloadBtn" class="ghost">Download CSV</button>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="customers">Customers</button>
    <button class="tab" data-tab="meeting_requests">Meeting Requests</button>
  </div>

  <section id="customers" class="list"></section>
  <section id="meeting_requests" class="list" style="display:none;"></section>
</main>

<script>
  // === SAME STRATEGY AS stamp-card-dashboard ===
  const SUPABASE_URL = "https://lhbtgjvejsnsrlstwlwl.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoYnRnanZlanNuc3Jsc3R3bHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODYzMjQsImV4cCI6MjA3MTc2MjMyNH0.tEKLgAaaZZ1jnODoEYWkFYbdBWYZGI1Lu-6rBvrzXBI"; // anon public key

  const connChip = document.getElementById("connChip");
  const connText = document.getElementById("connText");
  const customersEl = document.getElementById("customers");
  const meetingsEl = document.getElementById("meeting_requests");
  const customersCountEl = document.getElementById("customersCount");
  const meetingsCountEl = document.getElementById("meetingsCount");
  const lastRefreshEl = document.getElementById("lastRefresh");
  const limitSelect = document.getElementById("limitSelect");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refreshBtn");
  const autoBtn = document.getElementById("autoBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  let activeTab = "customers";
  let autoTimer = null;
  let allCustomers = [];
  let allMeetings = [];

  function setConn(ok, msg){
    connChip.classList.toggle("ok", ok);
    connChip.classList.toggle("err", !ok);
    connText.textContent = msg;
  }

  function fmtTime(ts){
    if(!ts) return "‚Äì";
    try { return new Date(ts).toLocaleString(); }
    catch { return ts; }
  }

  function inferCreatedAt(row){
    return row.created_at || row.inserted_at || row.timestamp || row.updated_at || null;
  }

  function safe(v){
    return (v === null || v === undefined) ? "" : String(v);
  }

  async function fetchTable(table, limit){
    // Try to order by created_at, but don't break if it doesn't exist
    const order = "created_at.desc";
    const url = `${SUPABASE_URL}/rest/v1/${table}?select=*&order=${order}&limit=${limit}`;

    const res = await fetch(url, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error(`${table}: ${txt}`);
    }
    return res.json();
  }

  function renderCustomers(rows){
    if(!rows?.length){
      customersEl.innerHTML = `<div class="empty">No customers yet.</div>`;
      return;
    }
    customersEl.innerHTML = rows.map(r=>{
      const created = inferCreatedAt(r);
      const name = r.profile_name || r.wa_name || r.first_name || "New customer";
      const number = r.customer_id || r.wa_id || r.cell_number || "";
      const latest = r.latest_message || r.state || r.status || "";

      return `
        <article class="card">
          <h3>${safe(name)}</h3>
          <div class="meta">
            <span class="pill">‚òéÔ∏è ${safe(number)}</span>
            ${created ? `<span>üïí ${fmtTime(created)}</span>` : ""}
            ${latest ? `<span class="pill">${safe(latest)}</span>` : ""}
          </div>

          <div class="kv">
            <div>customer_id</div><div>${safe(r.customer_id)}</div>
            <div>profile_name</div><div>${safe(r.profile_name)}</div>
            ${r.email !== undefined ? `<div>email</div><div>${safe(r.email)}</div>` : ""}
            ${r.number_of_visits !== undefined ? `<div>visits</div><div>${safe(r.number_of_visits)}</div>` : ""}
            ${r.days_since_last_visit !== undefined ? `<div>recency</div><div>${safe(r.days_since_last_visit)}</div>` : ""}
          </div>
        </article>
      `;
    }).join("");
  }

  function renderMeetings(rows){
    if(!rows?.length){
      meetingsEl.innerHTML = `<div class="empty">No meeting requests yet.</div>`;
      return;
    }
    meetingsEl.innerHTML = rows.map(r=>{
      const created = inferCreatedAt(r);
      const name = r.wa_name || r.name || "Meeting request";
      const number = r.customer_id || r.wa_id || "";

      return `
        <article class="card">
          <h3>${safe(name)}</h3>
          <div class="meta">
            <span class="pill">‚òéÔ∏è ${safe(number)}</span>
            ${created ? `<span>üïí ${fmtTime(created)}</span>` : ""}
            ${r.service ? `<span class="pill">Service: ${safe(r.service)}</span>` : ""}
          </div>

          <div class="kv">
            ${Object.keys(r).map(k=>`
              <div>${k}</div><div>${safe(r[k])}</div>
            `).join("")}
          </div>
        </article>
      `;
    }).join("");
  }

  function getFilteredRows(){
    const q = searchInput.value.trim().toLowerCase();
    const filterFn = row => {
      if(!q) return true;
      return Object.values(row).some(v => safe(v).toLowerCase().includes(q));
    };

    return activeTab === "customers"
      ? allCustomers.filter(filterFn)
      : allMeetings.filter(filterFn);
  }

  function applySearch(){
    const rows = getFilteredRows();
    if(activeTab === "customers"){
      renderCustomers(rows);
    } else {
      renderMeetings(rows);
    }
  }

  function toCSV(rows){
    if(!rows?.length) return "";
    const headers = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    const escape = v => `"${String(v ?? "").replace(/"/g,'""')}"`;
    const lines = [headers.join(",")];
    rows.forEach(row => {
      lines.push(headers.map(h => escape(row[h])).join(","));
    });
    return lines.join("\n");
  }

  function downloadCSV(){
    const rows = getFilteredRows();
    if(!rows.length) return;
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const filename = activeTab === "customers" ? "customers.csv" : "meeting_requests.csv";
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function loadData(){
    const limit = Number(limitSelect.value);
    try{
      setConn(true, "Connecting‚Ä¶");

      const [customers, meetings] = await Promise.all([
        fetchTable("customers", limit),
        fetchTable("meeting_requests", limit)
      ]);

      allCustomers = customers || [];
      allMeetings = meetings || [];

      customersCountEl.textContent = allCustomers.length;
      meetingsCountEl.textContent = allMeetings.length;

      renderCustomers(allCustomers);
      renderMeetings(allMeetings);
      applySearch();

      lastRefreshEl.textContent = new Date().toLocaleTimeString();
      setConn(true, "Connected");
    } catch(e){
      console.error(e);
      setConn(false, e.message || "Failed to fetch");
      customersEl.innerHTML = `<div class="empty">${safe(e.message)}</div>`;
      meetingsEl.innerHTML = `<div class="empty">${safe(e.message)}</div>`;
    }
  }

  function setTab(tab){
    activeTab = tab;
    document.querySelectorAll(".tab").forEach(b=>{
      b.classList.toggle("active", b.dataset.tab === tab);
    });
    customersEl.style.display = tab === "customers" ? "grid" : "none";
    meetingsEl.style.display = tab === "meeting_requests" ? "grid" : "none";
    applySearch();
  }

  function toggleAuto(){
    if(autoTimer){
      clearInterval(autoTimer);
      autoTimer = null;
      autoBtn.textContent = "Auto: Off";
      autoBtn.classList.remove("primary");
    } else {
      autoTimer = setInterval(loadData, 10000);
      autoBtn.textContent = "Auto: On (10s)";
      autoBtn.classList.add("primary");
    }
  }

  document.querySelectorAll(".tab").forEach(b=>
    b.addEventListener("click", ()=>setTab(b.dataset.tab))
  );
  refreshBtn.addEventListener("click", loadData);
  autoBtn.addEventListener("click", toggleAuto);
  limitSelect.addEventListener("change", loadData);
  searchInput.addEventListener("input", applySearch);
  downloadBtn.addEventListener("click", downloadCSV);

  loadData();
</script>

</body>
</html>
